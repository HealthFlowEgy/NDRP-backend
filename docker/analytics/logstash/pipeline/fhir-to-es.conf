# Egypt NDPR - Logstash Pipeline Configuration
# Consumes FHIR resources from Kafka and indexes to Elasticsearch

input {
  kafka {
    bootstrap_servers => "${KAFKA_BOOTSTRAP_SERVERS:kafka:9092}"
    topics => ["fhir-resources"]
    group_id => "ndpr-logstash-consumer"
    consumer_threads => 3
    codec => json
    decorate_events => true
    auto_offset_reset => "earliest"
  }
}

filter {
  # Parse the FHIR resource
  json {
    source => "message"
    target => "fhir"
  }

  # Extract resource type
  mutate {
    add_field => { "resource_type" => "%{[fhir][resourceType]}" }
  }

  # Process Patient resources
  if [fhir][resourceType] == "Patient" {
    # Extract National ID
    ruby {
      code => '
        identifiers = event.get("[fhir][identifier]") || []
        identifiers.each do |id|
          if id["system"] == "http://fhir.health.gov.eg/sid/national-id"
            event.set("national_id", id["value"])
          elsif id["system"] == "http://fhir.health.gov.eg/sid/health-id"
            event.set("health_id", id["value"])
          elsif id["system"] == "http://fhir.health.gov.eg/sid/uhis-number"
            event.set("uhis_number", id["value"])
          end
        end
      '
    }

    # Extract Arabic name
    ruby {
      code => '
        names = event.get("[fhir][name]") || []
        names.each do |name|
          if name["use"] == "official"
            event.set("name_arabic", name["text"])
          elsif name["use"] == "usual"
            event.set("name_english", name["text"])
          end
        end
      '
    }

    # Extract mobile number
    ruby {
      code => '
        telecoms = event.get("[fhir][telecom]") || []
        telecoms.each do |telecom|
          if telecom["system"] == "phone"
            event.set("mobile_number", telecom["value"])
            break
          end
        end
      '
    }

    # Extract governorate from address
    ruby {
      code => '
        addresses = event.get("[fhir][address]") || []
        if addresses.length > 0
          event.set("governorate", addresses[0]["state"])
          event.set("city", addresses[0]["city"])
        end
      '
    }

    # Extract UHIS extensions
    ruby {
      code => '
        extensions = event.get("[fhir][extension]") || []
        extensions.each do |ext|
          if ext["url"].include?("uhis-status")
            event.set("uhis_status", ext["valueCode"])
          elsif ext["url"].include?("uhis-tier")
            event.set("uhis_tier", ext["valueCode"])
          elsif ext["url"].include?("birth-governorate")
            event.set("birth_governorate", ext["valueCode"])
          end
        end
      '
    }

    # Add derived fields
    mutate {
      add_field => { 
        "gender" => "%{[fhir][gender]}"
        "birth_date" => "%{[fhir][birthDate]}"
      }
    }

    # Calculate age
    ruby {
      code => '
        birth_date = event.get("birth_date")
        if birth_date
          begin
            dob = Date.parse(birth_date)
            today = Date.today
            age = today.year - dob.year
            age -= 1 if today < dob + age.years
            event.set("age", age)
            event.set("age_group", case age
              when 0..4 then "0-4"
              when 5..14 then "5-14"
              when 15..24 then "15-24"
              when 25..44 then "25-44"
              when 45..64 then "45-64"
              else "65+"
            end)
          rescue => e
            event.set("age", nil)
          end
        end
      '
    }
  }

  # Process Coverage resources
  if [fhir][resourceType] == "Coverage" {
    ruby {
      code => '
        event.set("coverage_status", event.get("[fhir][status]"))
        event.set("coverage_type", event.get("[fhir][type][coding][0][code]"))
        
        period = event.get("[fhir][period]") || {}
        event.set("coverage_start", period["start"])
        event.set("coverage_end", period["end"])
        
        # Extract tier from class
        classes = event.get("[fhir][class]") || []
        classes.each do |cls|
          if cls["type"]["coding"][0]["code"] == "tier"
            event.set("coverage_tier", cls["value"])
          end
        end
      '
    }
  }

  # Add timestamp
  mutate {
    add_field => { 
      "indexed_at" => "%{@timestamp}"
      "source_topic" => "%{[@metadata][kafka][topic]}"
    }
  }

  # Remove raw message to save space
  mutate {
    remove_field => ["message", "fhir"]
  }
}

output {
  # Route to different indices based on resource type
  if [resource_type] == "Patient" {
    elasticsearch {
      hosts => ["${ELASTICSEARCH_HOSTS:elasticsearch:9200}"]
      index => "ndpr-patients-%{+YYYY.MM}"
      document_id => "%{health_id}"
    }
  } else if [resource_type] == "Coverage" {
    elasticsearch {
      hosts => ["${ELASTICSEARCH_HOSTS:elasticsearch:9200}"]
      index => "ndpr-coverage-%{+YYYY.MM}"
    }
  } else if [resource_type] == "Practitioner" {
    elasticsearch {
      hosts => ["${ELASTICSEARCH_HOSTS:elasticsearch:9200}"]
      index => "ndpr-practitioners-%{+YYYY.MM}"
    }
  } else {
    elasticsearch {
      hosts => ["${ELASTICSEARCH_HOSTS:elasticsearch:9200}"]
      index => "ndpr-fhir-%{+YYYY.MM}"
    }
  }

  # Also output to stdout for debugging (remove in production)
  # stdout { codec => rubydebug }
}
