name: Deploy OpenHIM to DigitalOcean

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'docker/docker-compose.jembi-platform.yml'
      - 'docker/.env.example'
      - 'scripts/deploy-openhim.sh'
      - '.github/workflows/deploy-openhim.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - development
          - staging
          - production

env:
  DO_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
  DROPLET_IP: ${{ secrets.DROPLET_IP }}
  SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ env.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.DROPLET_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true
      
      - name: Copy deployment script to droplet
        run: |
          scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            scripts/deploy-openhim.sh root@${{ env.DROPLET_IP }}:/tmp/
      
      - name: Execute deployment
        run: |
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -o ConnectionAttempts=10 -o UserKnownHostsFile=/dev/null \
            root@${{ env.DROPLET_IP }} \
            'bash /tmp/deploy-openhim.sh ${{ github.event.inputs.environment || 'production' }}'
      
      - name: Verify deployment
        run: |
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -o ConnectionAttempts=10 -o UserKnownHostsFile=/dev/null \
            root@${{ env.DROPLET_IP }} \
            'cd /opt/NDRP-backend/docker && docker-compose -f docker-compose.jembi-platform.yml ps'
      
      - name: Post deployment status
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const status = context.job.status;
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.ref,
              environment: 'production',
              auto_merge: false,
              required_contexts: []
            });
            
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.data.id,
              state: status === 'success' ? 'success' : 'failure',
              description: `OpenHIM deployment ${status === 'success' ? 'successful' : 'failed'}`,
              environment_url: 'http://157.245.20.251:9000'
            });

  notify:
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - name: Send Slack notification
        if: always()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "OpenHIM Deployment ${{ needs.deploy.result }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*OpenHIM Deployment Status*\n*Result:* ${{ needs.deploy.result }}\n*Branch:* ${{ github.ref }}\n*Commit:* ${{ github.sha }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Access:*\n• OpenHIM Console: http://157.245.20.251:9000\n• Registry API: http://157.245.20.251:8081\n• JeMPI UI: http://157.245.20.251:3033"
                  }
                }
              ]
            }
