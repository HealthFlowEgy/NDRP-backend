name: Deploy HealthFlow Sunbird RC

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'docker/**'
      - 'terraform/**'
      - '.github/workflows/deploy-sunbird-rc.yml'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  TF_VERSION: '1.6.0'

jobs:
  # ===========================================================================
  # Validate Configuration
  # ===========================================================================
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Docker Compose
        run: |
          cd docker
          docker compose config --quiet

      - name: Validate Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Terraform Format Check
        run: |
          cd terraform
          terraform fmt -check -recursive

      - name: Terraform Init & Validate
        run: |
          cd terraform
          terraform init -backend=false
          terraform validate

      - name: Lint Nginx Configuration
        run: |
          docker run --rm -v ${{ github.workspace }}/docker/configs/nginx.conf:/etc/nginx/nginx.conf:ro nginx:alpine nginx -t

  # ===========================================================================
  # Security Scan
  # ===========================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'docker/'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  # ===========================================================================
  # Deploy to Staging
  # ===========================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [validate, security-scan]
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://staging.sunbird.healthflow.eg
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.STAGING_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to Staging Server
        env:
          HOST: ${{ secrets.STAGING_HOST }}
          USER: ${{ secrets.STAGING_USER }}
        run: |
          # Copy configuration files
          rsync -avz --delete \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'terraform' \
            --exclude '*.md' \
            docker/ $USER@$HOST:/opt/healthflow/sunbird-rc/

          # Deploy services
          ssh $USER@$HOST << 'ENDSSH'
            cd /opt/healthflow/sunbird-rc
            
            # Pull latest images
            docker compose pull
            
            # Deploy with zero-downtime
            docker compose up -d --remove-orphans
            
            # Wait for services to be healthy
            sleep 30
            
            # Health check
            curl -sf http://localhost:8081/health || exit 1
            
            # Cleanup old images
            docker image prune -f
          ENDSSH

      - name: Verify Deployment
        run: |
          sleep 60
          curl -sf https://staging.sunbird.healthflow.eg/health || echo "Health check warning"

      - name: Notify Slack on Success
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "‚úÖ Sunbird RC deployed to Staging",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*HealthFlow Sunbird RC* deployed to *Staging*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ===========================================================================
  # Deploy to Production
  # ===========================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [validate, security-scan]
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment:
      name: production
      url: https://sunbird.healthflow.eg
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.PRODUCTION_HOST }} >> ~/.ssh/known_hosts

      - name: Create Backup
        env:
          HOST: ${{ secrets.PRODUCTION_HOST }}
          USER: ${{ secrets.PRODUCTION_USER }}
        run: |
          ssh $USER@$HOST << 'ENDSSH'
            cd /opt/healthflow/sunbird-rc
            
            # Create database backup
            docker exec healthflow-db pg_dumpall -U healthflow > /opt/healthflow/backups/pre-deploy-$(date +%Y%m%d_%H%M%S).sql
            
            # Backup current docker-compose
            cp docker-compose.yml docker-compose.yml.backup
          ENDSSH

      - name: Deploy to Production Server
        env:
          HOST: ${{ secrets.PRODUCTION_HOST }}
          USER: ${{ secrets.PRODUCTION_USER }}
        run: |
          # Copy configuration files
          rsync -avz --delete \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'terraform' \
            --exclude '*.md' \
            docker/ $USER@$HOST:/opt/healthflow/sunbird-rc/

          # Deploy services
          ssh $USER@$HOST << 'ENDSSH'
            cd /opt/healthflow/sunbird-rc
            
            # Pull latest images
            docker compose pull
            
            # Deploy with rolling update
            docker compose up -d --remove-orphans
            
            # Wait for services to be healthy
            sleep 60
            
            # Health check
            curl -sf http://localhost:8081/health || exit 1
            
            # Cleanup old images
            docker image prune -f
          ENDSSH

      - name: Verify Production Deployment
        run: |
          sleep 90
          # Verify all critical endpoints
          curl -sf https://sunbird.healthflow.eg/health || exit 1
          curl -sf https://sunbird.healthflow.eg/api/v1/health || echo "API health check warning"

      - name: Rollback on Failure
        if: failure()
        env:
          HOST: ${{ secrets.PRODUCTION_HOST }}
          USER: ${{ secrets.PRODUCTION_USER }}
        run: |
          ssh $USER@$HOST << 'ENDSSH'
            cd /opt/healthflow/sunbird-rc
            
            # Restore previous configuration
            if [ -f docker-compose.yml.backup ]; then
              mv docker-compose.yml.backup docker-compose.yml
              docker compose up -d
            fi
          ENDSSH

      - name: Notify Slack on Success
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "üöÄ Sunbird RC deployed to Production",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*HealthFlow Sunbird RC* deployed to *Production*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on Failure
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "‚ùå Sunbird RC Production deployment FAILED",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*HealthFlow Sunbird RC* deployment to *Production* FAILED!\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ===========================================================================
  # Infrastructure Provisioning (Terraform)
  # ===========================================================================
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: |
          cd terraform
          terraform init
        env:
          TF_VAR_do_token: ${{ secrets.DIGITALOCEAN_TOKEN }}

      - name: Terraform Plan
        run: |
          cd terraform
          terraform plan -no-color -out=tfplan
        env:
          TF_VAR_do_token: ${{ secrets.DIGITALOCEAN_TOKEN }}

      - name: Comment PR with Plan
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('terraform/tfplan', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## Terraform Plan\n```\n' + plan.substring(0, 65000) + '\n```'
            });

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [validate, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: infrastructure
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: |
          cd terraform
          terraform init
        env:
          TF_VAR_do_token: ${{ secrets.DIGITALOCEAN_TOKEN }}

      - name: Terraform Apply
        run: |
          cd terraform
          terraform apply -auto-approve
        env:
          TF_VAR_do_token: ${{ secrets.DIGITALOCEAN_TOKEN }}
